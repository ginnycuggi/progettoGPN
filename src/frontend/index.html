<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scambio di SchemiGPN</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <!-- CSS minimo SOLO per il popup -->
  <style>
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      max-width: 500px;
      width: 90%;
      border-radius: 8px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Benvenuto su Scambio di SchemiGPN</h1>

    <!-- RICERCA -->
    <form class="search-section" onsubmit="event.preventDefault(); handleSearch()">
      <input type="text" id="materiaSearch" placeholder="Materia (es. Matematica)">
      <input type="text" id="argomentoSearch" placeholder="Argomento (es. Equazioni)">
      <select id="annoSearch">
        <option value="">Seleziona anno scolastico</option>
        <option>Scuola Primaria - 1Âª</option>
        <option>Scuola Primaria - 2Âª</option>
        <option>Scuola Primaria - 3Âª</option>
        <option>Scuola Primaria - 4Âª</option>
        <option>Scuola Primaria - 5Âª</option>
        <option>Scuola Secondaria I Grado - 1Âª</option>
        <option>Scuola Secondaria I Grado - 2Âª</option>
        <option>Scuola Secondaria I Grado - 3Âª</option>
        <option>Scuola Secondaria II Grado - 1Âª</option>
        <option>Scuola Secondaria II Grado - 2Âª</option>
        <option>Scuola Secondaria II Grado - 3Âª</option>
        <option>Scuola Secondaria II Grado - 4Âª</option>
        <option>Scuola Secondaria II Grado - 5Âª</option>
        <option>UniversitÃ </option>
      </select>
      <button type="submit">Cerca</button>
    </form>

    <div class="account-link">
      <a href="#" class="register-button">ğŸ‘¤ Crea un account</a>
    </div>

    <p>Scegli come accedere alla piattaforma:</p>

    <div class="option">
      <h2>Abbonamento</h2>
      <p>Accedi pagando una quota mensile</p>
      <button onclick="alert('Funzione pagamento in arrivo!')">Paga ora</button>
    </div>

    <!-- SCAMBIO -->
    <div class="option">
      <h2>Scambio</h2>
      <p>Carica uno schema valido per poter ritirarne un altro</p>

      <input type="text" id="materia" placeholder="Materia (es. Matematica)">
      <input type="text" id="argomento" placeholder="Argomento (es. Equazioni)">

      <select id="annoScolastico">
        <option value="">Seleziona anno scolastico</option>
        <option>Scuola Primaria - 1Âª</option>
        <option>Scuola Primaria - 2Âª</option>
        <option>Scuola Primaria - 3Âª</option>
        <option>Scuola Primaria - 4Âª</option>
        <option>Scuola Primaria - 5Âª</option>
        <option>Scuola Secondaria I Grado - 1Âª</option>
        <option>Scuola Secondaria I Grado - 2Âª</option>
        <option>Scuola Secondaria I Grado - 3Âª</option>
        <option>Scuola Secondaria II Grado - 1Âª</option>
        <option>Scuola Secondaria II Grado - 2Âª</option>
        <option>Scuola Secondaria II Grado - 3Âª</option>
        <option>Scuola Secondaria II Grado - 4Âª</option>
        <option>Scuola Secondaria II Grado - 5Âª</option>
        <option>UniversitÃ </option>
      </select>

      <input type="file" id="schemaUpload"
        accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.ppt,.pptx,.txt">

      <button onclick="handleUpload()">Carica Schema</button>
    </div>

    <!-- SCHEMI CARICATI -->
    <div id="uploadedSchemas"></div>
  </div>

  <!-- MODAL RICERCA -->
  <div id="searchModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Risultati ricerca</h2>

      <div id="modalResults"></div>

      <div id="noResults" style="display:none;">
        <p>âŒ Nessuno schema trovato.</p>
        <p>Inserisci i dettagli per generare uno schema:</p>
        <input type="text" id="genMateria" placeholder="Materia (es. Matematica)">
        <input type="text" id="genArgomento" placeholder="Argomento (es. Equazioni)">
        <select id="genAnno">
          <option value="">Seleziona anno scolastico</option>
          <option>Scuola Primaria - 1Âª</option>
          <option>Scuola Primaria - 2Âª</option>
          <option>Scuola Primaria - 3Âª</option>
          <option>Scuola Primaria - 4Âª</option>
          <option>Scuola Primaria - 5Âª</option>
          <option>Scuola Secondaria I Grado - 1Âª</option>
          <option>Scuola Secondaria I Grado - 2Âª</option>
          <option>Scuola Secondaria I Grado - 3Âª</option>
          <option>Scuola Secondaria II Grado - 1Âª</option>
          <option>Scuola Secondaria II Grado - 2Âª</option>
          <option>Scuola Secondaria II Grado - 3Âª</option>
          <option>Scuola Secondaria II Grado - 4Âª</option>
          <option>Scuola Secondaria II Grado - 5Âª</option>
          <option>UniversitÃ </option>
        </select>
        <button onclick="generateSchema()">Genera</button>
      </div>

      <button onclick="closeModal()">Chiudi</button>
    </div>
  </div>

  <script>
    function handleUpload() {
      const fileInput = document.getElementById("schemaUpload");
      const materia = document.getElementById("materia").value.trim();
      const argomento = document.getElementById("argomento").value.trim();
      const anno = document.getElementById("annoScolastico").value;
      const container = document.getElementById("uploadedSchemas");

      if (!fileInput.files.length || !materia || !argomento || !anno) {
        alert("Compila tutti i campi e seleziona un file.");
        return;
      }

      const file = fileInput.files[0];

      const box = document.createElement("div");
      box.className = "schema-box";
      box.setAttribute("data-materia", materia.toLowerCase());
      box.setAttribute("data-argomento", argomento.toLowerCase());
      box.setAttribute("data-anno", anno.toLowerCase());

      box.innerHTML = `
        <strong>${file.name}</strong><br>
        <em>${materia} â€“ ${argomento}</em><br>
        <small>${anno}</small>
      `;

      container.appendChild(box);

      fileInput.value = "";
      document.getElementById("materia").value = "";
      document.getElementById("argomento").value = "";
      document.getElementById("annoScolastico").value = "";
    }

    function handleSearch() {
      const materia = document.getElementById("materiaSearch").value.trim().toLowerCase();
      const argomento = document.getElementById("argomentoSearch").value.trim().toLowerCase();
      const anno = document.getElementById("annoSearch").value.trim().toLowerCase();

      const results = document.getElementById("modalResults");
      const noResults = document.getElementById("noResults");
      const modal = document.getElementById("searchModal");
      const schemi = document.querySelectorAll(".schema-box");

      results.innerHTML = "";
      noResults.style.display = "none";

      if (!materia && !argomento && !anno) {
        alert("Inserisci almeno un campo da cercare.");
        return;
      }

      let trovati = 0;

      schemi.forEach(schema => {
        const matchMateria = !materia || schema.dataset.materia.includes(materia);
        const matchArgomento = !argomento || schema.dataset.argomento.includes(argomento);
        const matchAnno = !anno || schema.dataset.anno.includes(anno);

        if (matchMateria && matchArgomento && matchAnno) {
          results.appendChild(schema.cloneNode(true));
          trovati++;
        }
      });

      if (trovati === 0) {
        noResults.style.display = "block";
      }

      modal.style.display = "flex";
    }

    function closeModal() {
      document.getElementById("searchModal").style.display = "none";
    }

    async function generateSchema() {
      const materia = document.getElementById("genMateria").value.trim();
      const argomento = document.getElementById("genArgomento").value.trim();
      const anno = document.getElementById("genAnno").value.trim();

      if (!materia || !argomento || !anno) {
        alert("Compila tutti i campi per generare lo schema.");
        return;
      }

      // Mostra caricamento
      const results = document.getElementById("modalResults");
      const noResults = document.getElementById("noResults");
      noResults.style.display = "none";
      results.innerHTML = "<p>Ricerca in corso... ğŸ¤–</p>";

      // Cerca informazioni su Wikipedia
      const info = await searchWikipedia(argomento);

      // Genera schema basato sulle info
      const schema = generateAISchema(materia, argomento, anno, info);

      // Mostra lo schema
      const schemaDiv = document.createElement("div");
      schemaDiv.className = "generated-schema";
      schemaDiv.innerHTML = `<h3>Schema Generato per ${materia} - ${argomento} (${anno})</h3><pre id="schemaText">${schema}</pre><button onclick="downloadSchema()">Scarica come Immagine</button>`;
      results.innerHTML = "";
      results.appendChild(schemaDiv);
    }

    async function searchWikipedia(query) {
      try {
        const response = await fetch(`https://it.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`);
        const data = await response.json();
        return data.extract || "Informazioni non trovate.";
      } catch (e) {
        return "Errore nella ricerca.";
      }
    }

    function downloadSchema() {
      const schemaDiv = document.querySelector('.generated-schema');
      html2canvas(schemaDiv).then(canvas => {
        const link = document.createElement('a');
        link.download = 'schema.png';
        link.href = canvas.toDataURL();
        link.click();
      });
    }

    function generateAISchema(materia, argomento, anno, info) {
      let schema = `Schema per la materia: ${materia}\nArgomento: ${argomento}\nAnno Scolastico: ${anno}\n\n`;

      // Sintesi delle informazioni chiave
      const sintesi = sintetizzaInfo(info);

      // Adatta la complessitÃ  basata sull'anno
      const livello = getLivello(anno);

      schema += "1. Introduzione\n";
      schema += `   - ${sintesi.definizione || `Definizione di ${argomento} in ${materia}`}\n`;
      schema += `   - Importanza: ${sintesi.importanza || 'Fondamentale per la comprensione della materia'}\n\n`;

      schema += "2. Sviluppo\n";
      if (livello === 'base') {
        schema += `   - Concetti base: ${sintesi.concetti || `Elementi fondamentali di ${argomento}`}\n`;
        schema += "   - Esempi semplici\n";
      } else {
        schema += `   - Concetti avanzati: ${sintesi.concetti || `Approfondimenti su ${argomento}`}\n`;
        schema += "   - Esempi pratici e applicazioni\n";
        schema += "   - Collegamenti interdisciplinari\n";
      }
      schema += "\n";

      schema += "3. Conclusione\n";
      schema += "   - Riassunto dei punti principali\n";
      schema += "   - Riflessioni e collegamenti futuri\n\n";

      schema += "Risorse aggiuntive:\n";
      schema += "- Libri di testo consigliati\n";
      schema += "- Esercizi online e piattaforme educative\n";
      schema += "- Approfondimenti su siti affidabili\n";

      return schema;
    }

    function sintetizzaInfo(info) {
      // Sintesi semplice: estrai prime frasi
      const sentences = info.split('.').slice(0, 3);
      return {
        definizione: sentences[0] || '',
        importanza: sentences[1] || '',
        concetti: sentences[2] || ''
      };
    }

    function getLivello(anno) {
      if (anno.includes('Primaria')) return 'base';
      if (anno.includes('Secondaria I Grado')) return 'medio';
      return 'avanzato';
    }

    async function searchWikipedia(query) {
      try {
        const response = await fetch(`https://it.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`);
        const data = await response.json();
        return data.extract || "Informazioni non trovate.";
      } catch (e) {
        return "Errore nella ricerca.";
      }
    }

    function generateAISchema(materia, argomento, anno, info) {
      let schema = `Schema per la materia: ${materia}\nArgomento: ${argomento}\nAnno Scolastico: ${anno}\n\n`;

      schema += "Informazioni chiave da fonti online:\n";
      schema += info + "\n\n";

      schema += "1. Introduzione\n";
      schema += `   - Definizione di ${argomento} in ${materia}\n`;
      schema += "   - Importanza dell'argomento\n\n";

      schema += "2. Sviluppo\n";
      schema += `   - Concetti chiave relativi a ${argomento}\n`;
      schema += "   - Esempi pratici\n";
      schema += "   - Applicazioni nel contesto scolastico\n\n";

      schema += "3. Conclusione\n";
      schema += "   - Riassunto dei punti principali\n";
      schema += "   - Riflessioni finali\n\n";

      schema += "Risorse aggiuntive:\n";
      schema += "- Libri di testo\n";
      schema += "- Esercizi online\n";

      return schema;
    }
  </script>
</body>
</html>
